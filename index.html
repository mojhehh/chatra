<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Chat App</title>

  <!-- Tailwind CSS (optional, for looks) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col">

  <!-- Login Form (visible by default) -->
  <div id="loginForm" class="flex-1 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>

      <!-- Username only -->
      <input
        id="loginUsername"
        type="text"
        placeholder="Username"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Password -->
      <input
        id="loginPassword"
        type="password"
        placeholder="Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Remember me -->
      <label class="flex items-center gap-2 mb-3 text-sm text-gray-300">
        <input id="rememberMe" type="checkbox" class="h-4 w-4">
        <span>Remember me on this device</span>
      </label>

      <!-- Error / info messages -->
      <p id="loginError" class="text-sm text-red-400 min-h-[1.25rem] mb-1"></p>
      <p id="loginInfo" class="text-sm text-emerald-400 min-h-[1.25rem] mb-2"></p>

      <button
        id="loginBtn"
        class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600"
      >
        Login
      </button>

      <p class="mt-3 text-sm text-gray-400">
        Don't have an account?
        <a href="#" id="registerLink" class="text-blue-400">Register here</a>
      </p>
    </div>
  </div>

  <!-- Registration Form (hidden by default) -->
  <div id="registerForm" class="flex-1 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Register</h2>

      <!-- Username -->
      <input
        id="regUsername"
        type="text"
        placeholder="Username"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Password -->
      <input
        id="regPassword"
        type="password"
        placeholder="Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Confirm Password -->
      <input
        id="regPasswordConfirm"
        type="password"
        placeholder="Confirm Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Error / info messages -->
      <p id="registerError" class="text-sm text-red-400 min-h-[1.25rem] mb-2"></p>

      <button
        id="registerBtn"
        class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600"
      >
        Register
      </button>

      <p class="mt-3 text-sm text-gray-400">
        Already have an account?
        <a href="#" id="loginLink" class="text-blue-400">Login here</a>
      </p>
    </div>
  </div>

  <!-- Chat Interface (hidden by default) -->
  <div id="chatInterface" class="hidden flex-1 flex flex-col">

    <!-- Chat header with user + logout -->
    <div class="flex items-center justify-between px-4 py-2 bg-gray-900 border-b border-gray-800">
      <span id="chatUserLabel" class="text-sm text-gray-300"></span>
      <button
        id="logoutBtn"
        class="text-sm px-3 py-1 rounded bg-red-500 hover:bg-red-600"
      >
        Logout
      </button>
    </div>

    <!-- Chat Messages -->
    <div
      id="messages"
      class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-800"
    ></div>

    <!-- Message Input -->
    <div class="p-4 bg-gray-700 flex">
      <input
        id="msgInput"
        class="flex-1 p-3 rounded bg-gray-600 outline-none"
        placeholder="Type a message..."
      />
      <button
        id="sendBtn"
        class="ml-3 px-4 py-2 bg-blue-500 rounded hover:bg-blue-600"
      >
        Send
      </button>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC945jY7UEh4sOOuuk7OMZVXeIh333kxVk",
      authDomain: "chat-app-710f0.firebaseapp.com",
      projectId: "chat-app-710f0",
      storageBucket: "chat-app-710f0.firebasestorage.app",
      messagingSenderId: "225892837672",
      appId: "1:225892837672:web:f190f3585c4ffbd0f1c81d",
      databaseURL: "https://chat-app-710f0-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // DOM elements
    const loginForm      = document.getElementById("loginForm");
    const registerForm   = document.getElementById("registerForm");
    const chatInterface  = document.getElementById("chatInterface");

    const loginUsernameInput  = document.getElementById("loginUsername");
    const loginPasswordInput  = document.getElementById("loginPassword");
    const rememberMeCheckbox  = document.getElementById("rememberMe");
    const loginBtn            = document.getElementById("loginBtn");
    const loginError          = document.getElementById("loginError");
    const loginInfo           = document.getElementById("loginInfo");

    const regUsernameInput        = document.getElementById("regUsername");
    const regPasswordInput        = document.getElementById("regPassword");
    const regPasswordConfirmInput = document.getElementById("regPasswordConfirm");
    const registerBtn             = document.getElementById("registerBtn");
    const registerError           = document.getElementById("registerError");

    const msgInput    = document.getElementById("msgInput");
    const sendBtn     = document.getElementById("sendBtn");
    const messagesDiv = document.getElementById("messages");

    const registerLink  = document.getElementById("registerLink");
    const loginLink     = document.getElementById("loginLink");
    const logoutBtn     = document.getElementById("logoutBtn");
    const chatUserLabel = document.getElementById("chatUserLabel");

    // Helper: clear messages
    function clearLoginMessages() {
      loginError.textContent = "";
      loginInfo.textContent  = "";
    }

    function clearRegisterMessages() {
      registerError.textContent = "";
    }

    function updateChatUserLabel(username) {
      chatUserLabel.textContent = username ? `Logged in as ${username}` : "";
    }

    // On load: prefill username if "remember me" was used
    (function initRememberMe() {
      const remember      = localStorage.getItem("rememberMe") === "true";
      const savedUsername = localStorage.getItem("rememberedUsername");
      if (remember && savedUsername) {
        rememberMeCheckbox.checked = true;
        loginUsernameInput.value   = savedUsername;
      }
    })();

    // Switch to Register form
    registerLink.onclick = () => {
      clearLoginMessages();
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
    };

    // Switch to Login form
    loginLink.onclick = () => {
      clearRegisterMessages();
      registerForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
    };

    // Helper: make fake email from username
    function makeEmailFromUsername(username) {
      return username.toLowerCase() + "@gmail.com";
    }

    // ðŸ” Check if username is already taken in DB
    async function isUsernameTaken(username) {
      const snapshot = await db
        .ref("users")
        .orderByChild("username")
        .equalTo(username)
        .once("value");

      return snapshot.exists();
    }

    // Register User (username + password + confirm)
    registerBtn.onclick = async () => {
      clearRegisterMessages();

      const username        = regUsernameInput.value.trim();
      const password        = regPasswordInput.value.trim();
      const passwordConfirm = regPasswordConfirmInput.value.trim();

      if (!username || !password || !passwordConfirm) {
        registerError.textContent = "Please fill all fields.";
        return;
      }

      if (username.includes("@") || username.includes(" ")) {
        registerError.textContent = "Username can't have spaces or '@'.";
        return;
      }

      if (password !== passwordConfirm) {
        registerError.textContent = "Passwords do not match.";
        return;
      }

      // Check username in database
      if (await isUsernameTaken(username)) {
        registerError.textContent = "That username is already taken.";
        return;
      }

      const fakeEmail = makeEmailFromUsername(username);

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(
          fakeEmail,
          password
        );
        const user = userCredential.user;

        // Save the username in Firebase Database
        const userRef = db.ref("users/" + user.uid);
        await userRef.set({ username });

        // Store the username in localStorage (for chat)
        localStorage.setItem("username", username);

        // Log them out so they still go through login flow
        await auth.signOut();

        // Switch back to login, show success message
        registerForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
        clearLoginMessages();
        loginInfo.textContent = "Account created! You can log in now.";
      } catch (error) {
        console.error("Error registering:", error);
        if (error.code === "auth/email-already-in-use") {
          registerError.textContent = "That username is already taken.";
        } else if (error.code === "auth/weak-password") {
          registerError.textContent = "Password is too weak.";
        } else {
          registerError.textContent = "Could not register. Try again.";
        }
      }
    };

    // Sign In User (username + password only) with persistence
    loginBtn.onclick = async () => {
      clearLoginMessages();

      const username = loginUsernameInput.value.trim();
      const password = loginPasswordInput.value.trim();
      const remember = rememberMeCheckbox.checked;

      if (!username || !password) {
        loginError.textContent = "Please fill username and password.";
        return;
      }

      if (username.includes("@") || username.includes(" ")) {
        loginError.textContent = "Username can't have spaces or '@'.";
        return;
      }

      const fakeEmail = makeEmailFromUsername(username);

      try {
        // Set persistence based on "remember me"
        const persistence = remember
          ? firebase.auth.Auth.Persistence.LOCAL   // stay logged in across restarts
          : firebase.auth.Auth.Persistence.SESSION; // only until browser/tab closed

        await auth.setPersistence(persistence);

        const userCredential = await auth.signInWithEmailAndPassword(
          fakeEmail,
          password
        );
        const user = userCredential.user;

        // Store username for chat
        localStorage.setItem("username", username);

        // Handle remember me
        if (remember) {
          localStorage.setItem("rememberMe", "true");
          localStorage.setItem("rememberedUsername", username);
        } else {
          localStorage.removeItem("rememberMe");
          localStorage.removeItem("rememberedUsername");
        }

        updateChatUserLabel(username);

        // Show chat (messages listener starts in onAuthStateChanged)
        loginForm.classList.add("hidden");
        chatInterface.classList.remove("hidden");
      } catch (error) {
        console.error("Error signing in:", error);
        loginError.textContent = "Wrong username or password.";
      }
    };

    // Real-time message listener
    let messagesListener = null;
    let messagesRef      = null;

    function renderMessage(msg) {
      const wrapper = document.createElement("div");
      wrapper.className = "p-3 bg-gray-700 rounded";

      const userSpan = document.createElement("span");
      userSpan.className = "font-bold text-orange-300";
      userSpan.textContent = msg.user || "Unknown";

      const textSpan = document.createElement("span");
      textSpan.className = "ml-1 break-words";
      textSpan.textContent = msg.text || "";

      wrapper.appendChild(userSpan);
      wrapper.appendChild(document.createTextNode(": "));
      wrapper.appendChild(textSpan);

      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function startMessagesListener() {
      stopMessagesListener(); // avoid duplicates

      messagesRef = db.ref("messages");
      messagesListener = (snap) => {
        const msg = snap.val() || {};
        renderMessage(msg);
      };

      // attach
      messagesRef.on("child_added", messagesListener);
    }

    function stopMessagesListener() {
      if (messagesRef && messagesListener) {
        messagesRef.off("child_added", messagesListener);
      }
      messagesRef = null;
      messagesListener = null;
    }

    // Auto-handle already logged-in users on page load
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Get username from localStorage or from fake email
        let username = localStorage.getItem("username");
        if (!username && user.email) {
          username = user.email.split("@")[0];
          localStorage.setItem("username", username);
        }
        updateChatUserLabel(username || "User");

        loginForm.classList.add("hidden");
        registerForm.classList.add("hidden");
        chatInterface.classList.remove("hidden");

        // start realtime messages
        startMessagesListener();
      } else {
        // Not logged in
        stopMessagesListener();
        messagesDiv.innerHTML = "";

        chatInterface.classList.add("hidden");
        loginForm.classList.remove("hidden");
        updateChatUserLabel("");
      }
    });

    // Logout
    logoutBtn.onclick = async () => {
      try {
        await auth.signOut();
      } catch (e) {
        console.error("Error signing out:", e);
      }

      // UI reset happens in onAuthStateChanged
      msgInput.value        = "";
      loginPasswordInput.value = "";
      clearLoginMessages();

      const remember = localStorage.getItem("rememberMe") === "true";
      if (!remember) {
        localStorage.removeItem("username");
        localStorage.removeItem("rememberedUsername");
        loginUsernameInput.value = "";
      } else {
        const savedUsername = localStorage.getItem("rememberedUsername");
        loginUsernameInput.value = savedUsername || "";
      }
    };

    // Send a message
    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (text === "") return;

      const userObj = auth.currentUser;
      if (!userObj) {
        msgInput.value = "";
        return;
      }

      const username =
        localStorage.getItem("username") ||
        (userObj.email ? userObj.email.split("@")[0] : "Unknown");

      db.ref("messages").push({
        user: username,
        text: text,
        time: firebase.database.ServerValue.TIMESTAMP
      });

      msgInput.value = "";
    };

    // Optional: press Enter to send
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
  </script>

</body>
</html>
