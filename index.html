<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Chat App</title>

  <!-- Tailwind CSS (optional, for looks) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col">

  <!-- Login Form (visible by default) -->
  <div id="loginForm" class="flex-1 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>

      <!-- Username only -->
      <input
        id="loginUsername"
        type="text"
        placeholder="Username"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Password -->
      <input
        id="loginPassword"
        type="password"
        placeholder="Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Remember me -->
      <label class="flex items-center gap-2 mb-3 text-sm text-gray-300">
        <input id="rememberMe" type="checkbox" class="h-4 w-4">
        <span>Remember me on this device</span>
      </label>

      <!-- Error / info messages -->
      <p id="loginError" class="text-sm text-red-400 min-h-[1.25rem] mb-1"></p>
      <p id="loginInfo" class="text-sm text-emerald-400 min-h-[1.25rem] mb-2"></p>

      <button
        id="loginBtn"
        class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600"
      >
        Login
      </button>

      <p class="mt-3 text-sm text-gray-400">
        Don't have an account?
        <a href="#" id="registerLink" class="text-blue-400">Register here</a>
      </p>
    </div>
  </div>

  <!-- Registration Form (hidden by default) -->
  <div id="registerForm" class="flex-1 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Register</h2>

      <!-- Username -->
      <input
        id="regUsername"
        type="text"
        placeholder="Username"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Password -->
      <input
        id="regPassword"
        type="password"
        placeholder="Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Confirm Password -->
      <input
        id="regPasswordConfirm"
        type="password"
        placeholder="Confirm Password"
        class="mb-3 p-2 rounded w-full bg-gray-600"
        required
      />

      <!-- Error / info messages -->
      <p id="registerError" class="text-sm text-red-400 min-h-[1.25rem] mb-2"></p>

      <button
        id="registerBtn"
        class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600"
      >
        Register
      </button>

      <p class="mt-3 text-sm text-gray-400">
        Already have an account?
        <a href="#" id="loginLink" class="text-blue-400">Login here</a>
      </p>
    </div>
  </div>

  <!-- Chat Interface (hidden by default) -->
  <div id="chatInterface" class="hidden flex-1 flex flex-col">

    <!-- Chat header with user + logout -->
    <div class="flex items-center justify-between px-4 py-2 bg-gray-900 border-b border-gray-800">
      <span id="chatUserLabel" class="text-sm text-gray-300"></span>
      <button
        id="logoutBtn"
        class="text-sm px-3 py-1 rounded bg-red-500 hover:bg-red-600"
      >
        Logout
      </button>
    </div>

    <!-- Chat Messages -->
    <div
      id="messages"
      class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-800"
    ></div>

    <!-- Message Input -->
    <div class="p-4 bg-gray-700 flex">
      <input
        id="msgInput"
        class="flex-1 p-3 rounded bg-gray-600 outline-none"
        placeholder="Type a message..."
      />
      <button
        id="sendBtn"
        class="ml-3 px-4 py-2 bg-blue-500 rounded hover:bg-blue-600"
      >
        Send
      </button>
    </div>
  </div>

  <script>
    // --- GLOBAL ERROR LOGGING ---
    window.addEventListener("error", (event) => {
      console.error("[window error]", event.message, "at", event.filename + ":" + event.lineno);
    });

    window.addEventListener("unhandledrejection", (event) => {
      console.error("[unhandled rejection]", event.reason);
    });

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC945jY7UEh4sOOuuk7OMZVXeIh333kxVk",
      authDomain: "chat-app-710f0.firebaseapp.com",
      projectId: "chat-app-710f0",
      storageBucket: "chat-app-710f0.firebasestorage.app",
      messagingSenderId: "225892837672",
      appId: "1:225892837672:web:f190f3585c4ffbd0f1c81d",
      databaseURL: "https://chat-app-710f0-default-rtdb.firebaseio.com"
    };

    console.log("[init] starting firebase init");

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    console.log("[init] firebase initialized");

    // DOM elements
    const loginForm      = document.getElementById("loginForm");
    const registerForm   = document.getElementById("registerForm");
    const chatInterface  = document.getElementById("chatInterface");

    const loginUsernameInput  = document.getElementById("loginUsername");
    const loginPasswordInput  = document.getElementById("loginPassword");
    const rememberMeCheckbox  = document.getElementById("rememberMe");
    const loginBtn            = document.getElementById("loginBtn");
    const loginError          = document.getElementById("loginError");
    const loginInfo           = document.getElementById("loginInfo");

    const regUsernameInput        = document.getElementById("regUsername");
    const regPasswordInput        = document.getElementById("regPassword");
    const regPasswordConfirmInput = document.getElementById("regPasswordConfirm");
    const registerBtn             = document.getElementById("registerBtn");
    const registerError           = document.getElementById("registerError");

    const msgInput    = document.getElementById("msgInput");
    const sendBtn     = document.getElementById("sendBtn");
    const messagesDiv = document.getElementById("messages");

    const registerLink  = document.getElementById("registerLink");
    const loginLink     = document.getElementById("loginLink");
    const logoutBtn     = document.getElementById("logoutBtn");
    const chatUserLabel = document.getElementById("chatUserLabel");

    // Helper: clear messages
    function clearLoginMessages() {
      loginError.textContent = "";
      loginInfo.textContent  = "";
    }

    function clearRegisterMessages() {
      registerError.textContent = "";
    }

    function updateChatUserLabel(username) {
      chatUserLabel.textContent = username ? `Logged in as ${username}` : "";
      console.log("[ui] chat user label set to:", chatUserLabel.textContent);
    }

    // On load: prefill username if "remember me" was used
    (function initRememberMe() {
      try {
        const remember      = localStorage.getItem("rememberMe") === "true";
        const savedUsername = localStorage.getItem("rememberedUsername");
        console.log("[rememberMe] remember =", remember, "savedUsername =", savedUsername);
        if (remember && savedUsername) {
          rememberMeCheckbox.checked = true;
          loginUsernameInput.value   = savedUsername;
        }
      } catch (err) {
        console.error("[rememberMe] error reading localStorage", err);
      }
    })();

    // Switch to Register form
    registerLink.onclick = () => {
      clearLoginMessages();
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
      console.log("[ui] switched to register form");
    };

    // Switch to Login form
    loginLink.onclick = () => {
      clearRegisterMessages();
      registerForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
      console.log("[ui] switched to login form");
    };

    // Helper: make fake email from username
    function makeEmailFromUsername(username) {
      return username.toLowerCase() + "@gmail.com";
    }

    // ðŸ” Check if username is already taken in DB
    async function isUsernameTaken(username) {
      console.log("[users] checking if username taken:", username);
      try {
        const snapshot = await db
          .ref("users")
          .orderByChild("username")
          .equalTo(username)
          .once("value");
        const exists = snapshot.exists();
        console.log("[users] username taken =", exists);
        return exists;
      } catch (err) {
        console.error("[users] error while checking username", err);
        // If we can't check, be safe and say "taken" so we don't create bad state
        registerError.textContent = "Error checking username. Try again.";
        return true;
      }
    }

    // Register User (username + password + confirm)
    registerBtn.onclick = async () => {
      clearRegisterMessages();

      const username        = regUsernameInput.value.trim();
      const password        = regPasswordInput.value.trim();
      const passwordConfirm = regPasswordConfirmInput.value.trim();

      console.log("[register] submit", { username });

      if (!username || !password || !passwordConfirm) {
        registerError.textContent = "Please fill all fields.";
        return;
      }

      if (username.includes("@") || username.includes(" ")) {
        registerError.textContent = "Username can't have spaces or '@'.";
        return;
      }

      if (password !== passwordConfirm) {
        registerError.textContent = "Passwords do not match.";
        return;
      }

      // Check username in database
      if (await isUsernameTaken(username)) {
        if (!registerError.textContent) {
          registerError.textContent = "That username is already taken.";
        }
        return;
      }

      const fakeEmail = makeEmailFromUsername(username);
      console.log("[register] creating auth user", fakeEmail);

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(
          fakeEmail,
          password
        );
        const user = userCredential.user;
        console.log("[register] auth user created", user.uid);

        // Save the username in Firebase Database
        const userRef = db.ref("users/" + user.uid);
        await userRef.set({ username });
        console.log("[register] username saved to /users", user.uid);

        // Store the username in localStorage (for chat)
        localStorage.setItem("username", username);

        // Log them out so they still go through login flow
        await auth.signOut();
        console.log("[register] signed out after registration");

        // Switch back to login, show success message
        registerForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
        clearLoginMessages();
        loginInfo.textContent = "Account created! You can log in now.";
      } catch (error) {
        console.error("[register] Error registering:", error);
        if (error.code === "auth/email-already-in-use") {
          registerError.textContent = "That username is already taken.";
        } else if (error.code === "auth/weak-password") {
          registerError.textContent = "Password is too weak.";
        } else {
          registerError.textContent = "Could not register. Try again.";
        }
      }
    };

    // Sign In User (username + password only) with persistence
    loginBtn.onclick = async () => {
      clearLoginMessages();

      const username = loginUsernameInput.value.trim();
      const password = loginPasswordInput.value.trim();
      const remember = rememberMeCheckbox.checked;

      console.log("[login] submit", { username, remember });

      if (!username || !password) {
        loginError.textContent = "Please fill username and password.";
        return;
      }

      if (username.includes("@") || username.includes(" ")) {
        loginError.textContent = "Username can't have spaces or '@'.";
        return;
      }

      const fakeEmail = makeEmailFromUsername(username);

      try {
        // Set persistence based on "remember me"
        const persistence = remember
          ? firebase.auth.Auth.Persistence.LOCAL   // stay logged in across restarts
          : firebase.auth.Auth.Persistence.SESSION; // only until browser/tab closed

        console.log("[login] setting persistence", remember ? "LOCAL" : "SESSION");
        await auth.setPersistence(persistence);

        console.log("[login] signing in with email", fakeEmail);
        const userCredential = await auth.signInWithEmailAndPassword(
          fakeEmail,
          password
        );
        const user = userCredential.user;
        console.log("[login] signed in as", user.uid);

        // Store username for chat
        localStorage.setItem("username", username);

        // Handle remember me
        if (remember) {
          localStorage.setItem("rememberMe", "true");
          localStorage.setItem("rememberedUsername", username);
        } else {
          localStorage.removeItem("rememberMe");
          localStorage.removeItem("rememberedUsername");
        }

        updateChatUserLabel(username);

        // Show chat (messages listener also starts in onAuthStateChanged)
        loginForm.classList.add("hidden");
        chatInterface.classList.remove("hidden");

        // EXTRA: start listener right away too (in case onAuthStateChanged is slow)
        console.log("[login] manually starting messages listener after login");
        startMessagesListener();
      } catch (error) {
        console.error("[login] Error signing in:", error);
        loginError.textContent = "Wrong username or password.";
      }
    };

    // Real-time message listener
    let messagesListener = null;
    let messagesRef      = null;
    const seenMessageKeys = new Set();

    function renderMessage(msg) {
      const wrapper = document.createElement("div");
      wrapper.className = "p-3 bg-gray-700 rounded";

      const userSpan = document.createElement("span");
      userSpan.className = "font-bold text-orange-300";
      userSpan.textContent = msg.user || "Unknown";

      const textSpan = document.createElement("span");
      textSpan.className = "ml-1 break-words";
      textSpan.textContent = msg.text || "";

      wrapper.appendChild(userSpan);
      wrapper.appendChild(document.createTextNode(": "));
      wrapper.appendChild(textSpan);

      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function renderMessageOnce(key, msg) {
      if (!key) {
        console.warn("[messages] missing key for message", msg);
        renderMessage(msg);
        return;
      }
      if (seenMessageKeys.has(key)) return;
      seenMessageKeys.add(key);
      renderMessage(msg);
    }

    function startMessagesListener() {
      console.log("[messages] startMessagesListener called");
      stopMessagesListener(); // avoid duplicates
      seenMessageKeys.clear();
      messagesDiv.innerHTML = "";

      try {
        // order by time so history makes sense
        messagesRef = db.ref("messages").orderByChild("time");

        // Load existing messages once
        messagesRef.once(
          "value",
          (snap) => {
            const count = snap.numChildren();
            console.log("[messages] initial load snapshot, count =", count);
            snap.forEach((child) => {
              renderMessageOnce(child.key, child.val() || {});
            });
          },
          (error) => {
            console.error("[messages] error during initial load:", error);
          }
        );

        // Listen for new messages live
        messagesListener = (snap) => {
          const msg = snap.val() || {};
          console.log("[messages] child_added", { key: snap.key, msg });
          renderMessageOnce(snap.key, msg);
        };

        messagesRef.on(
          "child_added",
          messagesListener,
          (error) => {
            console.error("[messages] listener error:", error);
          }
        );
      } catch (err) {
        console.error("[messages] startMessagesListener crashed:", err);
      }
    }

    function stopMessagesListener() {
      console.log("[messages] stopMessagesListener called");
      try {
        if (messagesRef && messagesListener) {
          messagesRef.off("child_added", messagesListener);
        }
      } catch (err) {
        console.error("[messages] error while stopping listener:", err);
      }
      messagesRef = null;
      messagesListener = null;
      seenMessageKeys.clear();
    }

    // Auto-handle already logged-in users on page load
    auth.onAuthStateChanged((user) => {
      console.log("[auth] onAuthStateChanged user =", user ? user.uid : null);

      if (user) {
        // Get username from localStorage or from fake email
        let username = null;
        try {
          username = localStorage.getItem("username");
        } catch (err) {
          console.error("[auth] error reading username from localStorage", err);
        }

        if (!username && user.email) {
          username = user.email.split("@")[0];
          try {
            localStorage.setItem("username", username);
          } catch (err) {
            console.error("[auth] error writing username to localStorage", err);
          }
        }

        updateChatUserLabel(username || "User");

        loginForm.classList.add("hidden");
        registerForm.classList.add("hidden");
        chatInterface.classList.remove("hidden");

        console.log("[auth] starting messages listener from auth state change");
        startMessagesListener();
      } else {
        // Not logged in
        console.log("[auth] user is null, stopping listener and showing login");
        stopMessagesListener();
        messagesDiv.innerHTML = "";

        chatInterface.classList.add("hidden");
        loginForm.classList.remove("hidden");
        updateChatUserLabel("");
      }
    });

    // Logout
    logoutBtn.onclick = async () => {
      console.log("[logout] clicked");
      try {
        await auth.signOut();
        console.log("[logout] signOut complete");
      } catch (e) {
        console.error("[logout] Error signing out:", e);
      }

      // UI reset happens in onAuthStateChanged
      msgInput.value           = "";
      loginPasswordInput.value = "";
      clearLoginMessages();

      const remember = localStorage.getItem("rememberMe") === "true";
      if (!remember) {
        localStorage.removeItem("username");
        localStorage.removeItem("rememberedUsername");
        loginUsernameInput.value = "";
      } else {
        const savedUsername = localStorage.getItem("rememberedUsername");
        loginUsernameInput.value = savedUsername || "";
      }
    };

    // Send a message
    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (text === "") return;

      const userObj = auth.currentUser;
      if (!userObj) {
        console.warn("[send] tried to send while not logged in");
        msgInput.value = "";
        return;
      }

      const username =
        localStorage.getItem("username") ||
        (userObj.email ? userObj.email.split("@")[0] : "Unknown");

      console.log("[send] sending message", { username, text });

      db.ref("messages")
        .push({
          user: username,
          text: text,
          time: firebase.database.ServerValue.TIMESTAMP
        })
        .then((ref) => {
          console.log("[send] message saved under key", ref.key);
        })
        .catch((error) => {
          console.error("[send] error sending message:", error);
        });

      msgInput.value = "";
    };

    // Optional: press Enter to send
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
  </script>

</body>
</html>
