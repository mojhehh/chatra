<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Chat App</title>

  <!-- Tailwind CSS (optional, for looks) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col">

  <!-- Login Form (visible by default) -->
  <div id="loginForm" class="flex-1 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
      <input id="emailInput" type="email" placeholder="Email" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <input id="passwordInput" type="password" placeholder="Password" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <input id="usernameInput" type="text" placeholder="Username" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <button id="loginBtn" class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600">Login</button>
      <p class="mt-3 text-sm text-gray-400">Don't have an account? <a href="#" id="registerLink" class="text-blue-400">Register here</a></p>
    </div>
  </div>

  <!-- Registration Form (hidden by default) -->
  <div id="registerForm" class="flex-1 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Register</h2>
      <input id="regEmailInput" type="email" placeholder="Email" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <input id="regPasswordInput" type="password" placeholder="Password" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <input id="regUsernameInput" type="text" placeholder="Username" class="mb-4 p-2 rounded w-full bg-gray-600" required>
      <button id="registerBtn" class="w-full p-3 bg-blue-500 rounded hover:bg-blue-600">Register</button>
      <p class="mt-3 text-sm text-gray-400">Already have an account? <a href="#" id="loginLink" class="text-blue-400">Login here</a></p>
    </div>
  </div>

  <!-- Chat Interface (hidden by default) -->
  <div id="chatInterface" class="hidden flex-1 flex flex-col">

    <!-- Chat Messages -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-800">
    </div>

    <!-- Message Input -->
    <div class="p-4 bg-gray-700 flex">
      <input id="msgInput" class="flex-1 p-3 rounded bg-gray-600 outline-none" placeholder="Type a message...">
      <button id="sendBtn" class="ml-3 px-4 py-2 bg-blue-500 rounded hover:bg-blue-600">
        Send
      </button>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC945jY7UEh4sOOuuk7OMZVXeIh333kxVk",
      authDomain: "chat-app-710f0.firebaseapp.com",
      projectId: "chat-app-710f0",
      storageBucket: "chat-app-710f0.firebasestorage.app",
      messagingSenderId: "225892837672",
      appId: "1:225892837672:web:f190f3585c4ffbd0f1c81d",
      databaseURL: "https://chat-app-710f0-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM elements
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const chatInterface = document.getElementById("chatInterface");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const usernameInput = document.getElementById("usernameInput");
    const loginBtn = document.getElementById("loginBtn");
    const regEmailInput = document.getElementById("regEmailInput");
    const regPasswordInput = document.getElementById("regPasswordInput");
    const regUsernameInput = document.getElementById("regUsernameInput");
    const registerBtn = document.getElementById("registerBtn");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const messagesDiv = document.getElementById("messages");

    let messagesListener = null;

    const toggleForms = (showLogin) => {
      if (showLogin) {
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        chatInterface.classList.add("hidden");
      } else {
        loginForm.classList.add("hidden");
        registerForm.classList.add("hidden");
        chatInterface.classList.remove("hidden");
      }
    };

    const clearMessages = () => {
      messagesDiv.innerHTML = "";
    };

    const renderMessage = ({ user, text, time }) => {
      const container = document.createElement("div");
      container.className = "p-3 bg-gray-700 rounded";

      const header = document.createElement("div");
      header.className = "flex items-center justify-between mb-1";

      const userLabel = document.createElement("span");
      userLabel.className = "font-bold text-orange-300";
      userLabel.textContent = user || "Unknown";

      const timestamp = document.createElement("span");
      timestamp.className = "text-xs text-gray-400";
      timestamp.textContent = new Date(time || Date.now()).toLocaleTimeString();

      header.appendChild(userLabel);
      header.appendChild(timestamp);

      const messageBody = document.createElement("p");
      messageBody.className = "text-gray-100";
      messageBody.textContent = text;

      container.appendChild(header);
      container.appendChild(messageBody);

      messagesDiv.appendChild(container);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    // Switch to Register form
    document.getElementById("registerLink").onclick = () => {
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
    };

    // Switch to Login form
    document.getElementById("loginLink").onclick = () => {
      registerForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
    };

    const saveUsername = async (uid, username) => {
      if (!uid || !username) return;
      const userRef = db.ref("users/" + uid);
      await userRef.set({ username });
      localStorage.setItem("username", username);
    };

    // Register User
    registerBtn.onclick = async () => {
      const email = regEmailInput.value.trim();
      const password = regPasswordInput.value.trim();
      const username = regUsernameInput.value.trim();

      if (!email || !password || !username) {
        alert("Please fill all fields.");
        return;
      }

      try {
        const { user } = await auth.createUserWithEmailAndPassword(email, password);
        await saveUsername(user.uid, username);
        await user.updateProfile({ displayName: username });

        await auth.signOut();
        toggleForms(true);
        alert("Registration successful! Please login.");
      } catch (error) {
        console.error("Error registering:", error);
        alert("Registration failed: " + error.message);
      }
    };

    // Sign In User
    loginBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      const username = usernameInput.value.trim();

      if (!email || !password || !username) {
        alert("Please fill all fields.");
        return;
      }

      try {
        const { user } = await auth.signInWithEmailAndPassword(email, password);

        const userRef = db.ref("users/" + user.uid);
        const snapshot = await userRef.once("value");
        const storedUsername = snapshot.val()?.username || username;
        await saveUsername(user.uid, storedUsername);

        toggleForms(false);
        attachMessageListener();
      } catch (error) {
        console.error("Error signing in:", error);
        alert("Login failed: " + error.message);
      }
    };

    const detachMessageListener = () => {
      if (messagesListener) {
        messagesListener.off();
        messagesListener = null;
      }
    };

    const attachMessageListener = () => {
      detachMessageListener();

      clearMessages();
      messagesListener = db.ref("messages").limitToLast(50);
      messagesListener.on("child_added", (snap) => {
        const msg = snap.val();
        if (!msg?.text) return;
        renderMessage(msg);
      });
    };

    // Send a message
    const sendMessage = () => {
      const text = msgInput.value.trim();
      if (!text) return;

      const username = localStorage.getItem("username") || auth.currentUser?.displayName || "Anonymous";
      const uid = auth.currentUser?.uid;
      if (!uid) {
        alert("You must be logged in to send messages.");
        return;
      }

      db.ref("messages").push({
        user: username,
        text,
        uid,
        time: Date.now()
      });

      msgInput.value = "";
    };

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    auth.onAuthStateChanged((user) => {
      if (user) {
        const username = localStorage.getItem("username") || user.displayName || "User";
        localStorage.setItem("username", username);
        toggleForms(false);
        attachMessageListener();
      } else {
        toggleForms(true);
        detachMessageListener();
        clearMessages();
      }
    });
  </script>

</body>
</html>
